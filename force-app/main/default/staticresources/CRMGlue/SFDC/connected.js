define(["util","i18next","agent/voice","config","SFDC/api","SFDC/tracking","SFDC/case","SFDC/task","SFDC/pop","agent/interaction","moment"],function(a,b,c,d,e,f,g,h,i,j,k){function l(a){var b=JSON.parse(a.message||a.data);switch(console.log("receiveSFMessage CTIEvent = "+b.action),b.action){case"AttachData":j.attachData(b);break;case"MarkDone":j.markDone(b);break;case"ReleaseCall":j.releaseCall(b);break;case"UserEvent":j.userEvent(b);break;case"ContactSelected":console.log(n+"ContactSelected - "+b.objectId+", "+b.id),b.objectId&&b.id?ConnectorController.getContact(b.objectId,null,function(a){var c=f.getParams(b.id);null!==c&&(c.contact=a,i.start(c))}):console.error("No contact details given to the connector");break;case"CaseSelected":console.log(n+"CaseSelected - "+b.objectId+", "+b.id),ConnectorController.getContact(b.objectId,null,function(a){var c=f.getParams(b.id);null!==c&&(c.contact=a,c.caseId=b.caseId,c.caseNumber=b.caseNumber,i.start(c))})}}function m(a){var b=null;b="string"==typeof a.result?JSON.parse(a.result):a;var e=null,f=null;console.log(n+"dial: "+b.number),d.beforeDial&&(console.log(n+"go to custom dial handler"),d.beforeDial(b));var h={phoneNumber:b.number,userData:b.userData?b.userData:{}},i=function(){var a=$.Deferred();if(console.log(n+"getContact: "+(b.object||b.objectType)),"Contact"===b.object||"Contact"===b.objectType)e=g.getCaseNumber(b.objectId||b.recordId),f=b.objectId||b.recordId,console.log(n+"case number is "+e+", contact is "+f),a.resolve();else if("Account"===b.object||"Account"===b.objectType)f=b.objectId||b.recordId,console.log(n+"account is "+f),a.resolve();else if("Case"===b.object||"Case"===b.objectType)e=b.objectName||b.recordId,console.log(n+"case number is "+e),a.resolve();else if("Task"===b.object||"Task"===b.objectType){var c=b.objectId||b.recordId;console.log(n+"task is "+c),ConnectorController.getContactByTask(c,function(b){f=b.WhoId,e=b.CallObject,console.log(n+"contact is "+f+", case number is "+e),a.resolve()})}else console.log(n+"object is "+b.object),a.resolve();return a};(function(){var a=$.Deferred();try{i().done(function(){null!==e&&""!==o.searchCaseKVP&&(h.userData[o.searchCaseKVP]=e),null!==f?(console.log(n+"getDetails: "+f),ConnectorController.getContact(f,null,function(b){null!==b&&(h.userData.sfdcId=b.Id,h.userData.sfdcName=b.Name),a.resolve()})):a.resolve()})}catch(b){console.error(n+b.stack),a.resolve()}return a})().done(setTimeout(function(){c.dial(h)},d.UPDATE_DELAY))}var n="SFDC/connected: ",o=null;return{initialize:function(c){try{console.log(n+"initialize"),o=c,g.initialize(c.searchCaseKVP),e.enableClickToDial(),e.onClickToDial(m),e.addEventListener(l);var j=function(a){console.log(n+"voice.pop");var b=a.call;try{var e=function(a){console.log(n+"aniSearch");var c=b.ani;"Outbound"===b.callType&&(c=b.dnis),console.log(n+"ANI="+c),d.NO_ANI_SEARCH?(console.log(n+"aniSearch - not enabled"),x(a,"phoneNumber",c)):ConnectorController.findContact("Phone",c,b.userData,function(b){null!==b?b.length>1?(console.log(n+"contact search - multiple objects returned"),x(a,"phoneNumber",b,!0)):void 0===b.Id?(console.log(n+"contact search - no id returned"),x(a,"phoneNumber",c,!0)):(b.Name=$("<div/>").html(b.Name).text(),console.log(n+"findContact - "+b.Id+", "+b.Name),a.contact=b,i.start(a)):(console.log(n+"contact search - no records found"),x(a,"phoneNumber",c))}),console.log(n+"aniSearch - finished")},f={searchField:a.fieldName,searchValue:a.fieldValue,searchType:c.voiceSearchType,ixn:b,popOnly:"Consult"===b.callType,noCase:"Outbound"===b.callType},h=!0;d.overrideVoicePop&&(console.log(n+"overrideVoicePop"),h=d.overrideVoicePop(b,f,e,w)),h&&g.search(f).then(function(a,b,c){null!==a&&(f.contact=a,f.caseId=b,f.caseNumber=c,i.start(f))},function(){return w(f)}).then(null,function(){e(f)})}catch(a){console.error(n+a.stack)}console.log(n+"voice.pop - finished")};a.getInstance("voice.pop").unsubscribeExt(),a.getInstance("voice.pop").subscribeExt(j);var k=function(a){console.log(n+"voice.ended");try{var b=a.call,c=b.id,g="";b.notes&&(g+="Note:\n"+b.notes+"\n\n"),e.fireOnCallEnd(b,b.duration,b.userData[d.DISPOSITION_KVP]),h.finish(c,g,b,b.duration).done(function(){f.remove(c)})}catch(a){console.error(n+a.stack)}};a.getInstance("voice.ended").unsubscribeExt(),a.getInstance("voice.ended").subscribeExt(k);var p=function(a){console.log(n+"email.pop");var b=a.email,d={searchField:a.fieldName,searchValue:a.fieldValue,searchType:c.emailSearchType,ixn:b};g.search(d).then(function(a,b,c){null!==a?(console.log(n+"email.pop - attempt pop"),d.contact=a,d.caseId=b,d.caseNumber=c,i.start(d)):console.log(n+"email.pop - no pop")},function(){return console.log(n+"email.pop - do field search"),w(d)}).then(null,function(){return console.log(n+"email.pop - do search based on from"),x(d,"email",b.from)})};a.getInstance("email.pop").unsubscribeExt(),a.getInstance("email.pop").subscribeExt(p);var q=function(a){console.log(n+"email.ended");try{var b=a.email,c=b.id;if(f.exists(c)){var g="";b.notes&&(g+="Note:\n"+b.notes+"\n\n"),g+="Email\n",g+="Msg: "+b.emailDescription,e.fireOnCallEnd(b,b.duration,b.userData[d.DISPOSITION_KVP]),h.finish(c,g,b,b.duration).done(function(){f.remove(c)})}else console.log(n+"could not find "+c)}catch(a){console.error(n+a.stack)}};a.getInstance("email.ended").unsubscribeExt(),a.getInstance("email.ended").subscribeExt(q);var r=function(a){console.log(n+"chat.pop");var b=a.chat,d={searchField:a.fieldName,searchValue:a.fieldValue,searchType:c.chatSearchType,ixn:b};g.search(d).then(function(a,b,c){null!==a&&(d.contact=a,d.caseId=b,d.caseNumber=c,i.start(d))},function(){return w(d)}).then(null,function(){return x(d,d.searchType,d.searchValue)})};a.getInstance("chat.pop").unsubscribeExt(),a.getInstance("chat.pop").subscribeExt(r);var s=function(a){console.log(n+"chat.ended");try{var b=a.chat,c=b.id;if(f.exists(c)){var d="";b.notes&&(d+="Note:\n"+b.notes+"\n\n"),d+="Transcript:\n"+b.transcript,h.finish(c,d,b,b.duration).done(function(){f.remove(c)})}else console.log(n+"could not find "+c)}catch(a){console.error(n+a.stack)}};a.getInstance("chat.ended").unsubscribeExt(),a.getInstance("chat.ended").subscribeExt(s);var t=function(a){console.log(n+"openmedia.pop");var b=a.openmedia,d={searchField:a.fieldName,searchValue:a.fieldValue,searchType:c.openmediaSearchType,ixn:b};g.search(d).then(function(a,b,c){null!==a&&(d.contact=a,d.caseId=b,d.caseNumber=c,i.start(d))},function(){return w(d)}).then(null,function(){return x(d,d.searchType,d.searchValue)})};a.getInstance("openmedia.pop").unsubscribeExt(),a.getInstance("openmedia.pop").subscribeExt(t);var u=function(a){console.log(n+"openmedia.ended");try{var b=a.openmedia,c=b.id;if(f.exists(c)){var g="";b.notes&&(g+="Note:\n"+b.notes+"\n\n"),b.transcript&&(g+="Transcript:\n"+b.transcript),e.fireOnCallEnd(b,b.duration,b.userData[d.DISPOSITION_KVP]),h.finish(c,g,b,b.duration).done(function(){f.remove(c)})}else console.log(n+"could not find "+c)}catch(a){console.error(n+a.stack)}};a.getInstance("openmedia.ended").unsubscribeExt(),a.getInstance("openmedia.ended").subscribeExt(u);var v=function(a){console.log(n+"preview.pop");var b=a.record,d=function(){var c=b.phone;console.log(n+"phoneSearch - "+c);var d={ixn:b,searchValue:a.fieldValue,popOnly:!0};ConnectorController.findContact("Phone",c,b.userData,function(b){null!==b?b.length>1?(console.log(n+"contact search - multiple objects returned"),x(d,"phoneNumber",b,!0)):void 0===b.Id?(console.log(n+"contact search - no id returned"),x(d,"phoneNumber",c,!0)):(b.Name=$("<div/>").html(b.Name).text(),console.log(n+"phoneSearch: "+b.Id+", "+b.Name+" ("+a.record.id+")"),d.contact=b,i.start(d)):(console.log(n+"contact search - no records found"),x(d,"phoneNumber",c))}),console.log(n+"phoneSearch - finished")},e={searchField:a.fieldName,searchValue:a.fieldValue,searchType:c.voiceSearchType,ixn:b,popOnly:!0};w(e).then(null,d)};a.getInstance("preview.pop").unsubscribeExt(v),a.getInstance("preview.pop").subscribeExt(v);var w=function(a){var b=$.Deferred(),c=a.searchField,d=a.searchValue,e=a.ixn,f=a.searchType||null;try{console.log(n+"fieldSearch"),e.userData.sfdcId?(console.log(n+"fieldSearch - sfdcId="+e.userData.sfdcId),a.contact={Id:e.userData.sfdcId,Name:e.userData.sfdcName},i.start(a)):null!==c&&null!==d?(console.log(n+"fieldSearch - search field="+c),console.log(n+"fieldSearch - search value="+d),void 0!==d&&""!==d?ConnectorController.findContact(c,d,e.userData,function(c){null!==c?(c.length>1?(console.log(n+"contact search - multiple objects returned"),x(a,f,c,!0)):void 0===c.Id?(console.log(n+"fieldSearch - no id returned"),x(a,f,d,!0)):(c.Name=$("<div/>").html(c.Name).text(),console.log(n+"fieldSearch - "+c.Id+", "+c.Name+" ("+e.id+")"),a.contact=c,i.start(a),console.log(n+"fieldSearch - success for "+e.id)),b.resolve()):(console.log(n+"fieldSearch - no field value found"),b.reject())}):(console.log(n+"fieldSearch - no field KVP in interaction"),b.reject())):(console.log(n+"fieldSearch - no field search"),b.reject())}catch(a){console.error(n+a.stack),b.reject()}return console.log(n+"fieldSearch - finished"),b.promise()},x=function(a,c,g,j){function k(c){console.log(n+"open search page"),f.setParams(a),e.openPrimaryTab(null,c,!0,b.t("search.search")),l.resolve()}console.log(n+"doSearch - "+c+", "+g);var l=$.Deferred(),m=d.SEARCH_URL+"?id="+a.ixn.id;return d.NO_DEFAULT_SEARCH&&!j?(console.log(n+"doSearch - not enabled, do pop instead"),i.start(),l.resolve()):d.customSearchQuery?(console.log(n+"doSearch - use custom query"),d.NEW_TASK_NO_CONTACT_FOUND&&"Outbound"!==a.ixn.callType||d.NEW_OUTBOUND_TASK_NO_CONTACT_FOUND&&"Outbound"===a.ixn.callType?d.customSearchQuery(a,c,g,function(b){h.start(a).then(function(){setTimeout(function(){k(m+b)},d.UPDATE_DELAY)})}):d.customSearchQuery(a,c,g,function(a){k(m+a)})):void 0!==g&&null!==g&&""!==g&&null!==c?(console.log(n+"doSearch - use search query"),d.NEW_TASK_NO_CONTACT_FOUND&&"Outbound"!==a.ixn.callType||d.NEW_OUTBOUND_TASK_NO_CONTACT_FOUND&&"Outbound"===a.ixn.callType?h.start(a).then(function(){setTimeout(function(){k(m+"&"+c+"="+g)},d.UPDATE_DELAY)}):k(m+"&"+c+"="+g)):(console.log(n+"doSearch - NO search query"),d.NEW_TASK_NO_CONTACT_FOUND&&"Outbound"!==a.ixn.callType||d.NEW_OUTBOUND_TASK_NO_CONTACT_FOUND&&"Outbound"===a.ixn.callType?h.start(a).then(function(){setTimeout(function(){k(m)},d.UPDATE_DELAY)}):k(m)),l.promise()}}catch(a){console.error(n+"ERROR - "+a.stack)}console.log(n+"initialized"),a.getInstance("sfdc.connected").publish("initialized")}}});