define(["util","SFDC/api","config","i18next","SFDC/tracking","agent/interaction"],function(a,b,c,d,e,f){var g=null,h={},i=function(a){if(console.log("SFDC/case: search"),c.caseSearchOverride)return c.caseSearchOverride(a);var f=$.Deferred(),h=a.ixn;if(c.SHOW_CASE&&null!==g&&void 0!==h.userData){var i=h.userData[g];console.log("SFDC/case: search "+g+"="+i),void 0!==i&&""!==i?ConnectorController.findCase(i,function(g){if(null!==g)console.log("SFDC/case: case found ("+g.Id+", "+g.ContactId+")"),ConnectorController.getContact(g.ContactId,null,function(a){ConnectorController.updateTask,null!==a?f.resolve(a,g.Id,i):(console.log("SFDC/case: contact not found"),f.reject())});else if(console.log("SFDC/case: case not found"),c.SEARCH_CASE_IF_WRONG_CASE){var j="/apex/CRMCaseSearch?id="+h.id+"&caseNumber="+i;console.log("SFDC/case: opening case search: "+j),e.setParams(a),b.openPrimaryTab(null,j,!0,d),f.resolve(null)}else console.log("SFDC/case: keep going with search"),f.reject()}):(console.log("SFDC/case: no case KVP in interaction"),f.reject())}else console.log("SFDC/case: no case search"),f.reject();return console.log("SFDC/case: search - finished"),f.promise()},j=function(i){if(console.log("SFDC/case: pop"),c.casePopOverride)return c.casePopOverride(i);var j=i.ixn,k=i.contact,l=i.searchKVP||null,m=i.caseId||null,n=i.caseNumber||null,o=i.popOnly||!1,p=i.noCase||!1,q=$.Deferred(),r=e.getPrimaryTabId(j.id);if(!c.SHOW_CASE||o||p)console.log("SFDC/case: no case pop"),q.reject();else{var s=e.getCurrentPrimaryTabId(),t=e.getCurrentPrimaryTabObjectId();if(c.NEW_CASE_ON_POP&&null===m){var u={};void 0!==j.userData&&$.each(c.CASE_MAP,function(a,b){var c=b.split(":"),d=c[0];if(c.length>1){var e=j.userData[c[1]];void 0!==e&&(console.log("SFDC/case: Map - "+d+":"+e),u[d]=e)}}),void 0!==j.userData[l]||c.NEW_CASE_IF_NO_SEARCH_KVP_PRESENT?ConnectorController.createCase(k?k.Id:null,k?k.AccountId||null:null,d.t("mediaType."+j.mediaType),d.t("case.new"),j.userData,u,function(e){if(null!==e){console.log("SFDC/case: redirect to new case - "+e.Id+" under "+r+" or "+s);var l=function(a){if(a.success||console.warn("SFDC/case: could not open tab"),null!==g&&e.CaseNumber){var b={id:j.id,mediaType:j.mediaType,userData:{}};b.userData[g]=e.CaseNumber,k&&(h[k.Id]=e.CaseNumber);var c={action:"AttachData",actionData:{id:j.id,userData:b.userData}};f.attachData(c)}q.resolve(e.Id)},m="/"+e.Id;c.OPEN_NEW_CASE_IN_EDIT_MODE&&(m+="/e"),null!==r?(console.log("SFDC/case: primaryTabId="+r),b.openSubtab(r,m,!0,d.t("case.new"),null,function(a){l(a)})):null!==s&&null!==t&&(k&&t===k.Id||k&&t===k.AccountId)?(console.log("SFDC/case: currentPrimaryTabId="+s),b.openSubtab(s,m,!0,d.t("case.new"),null,function(a){l(a)})):(console.log("SFDC/case: open new primary tab"),b.openPrimaryTab(null,m,!0,d.t("case.new"),function(a){l(a)})),a.getInstance("case.created").publish(i)}else console.warn("SFDC/case: Could not create case"),q.reject()}):(console.log("SFDC/case: No present KVP - did not create case"),q.reject())}else if(null!==m){console.log("SFDC/case: redirect to existing case - "+m+" under "+r+" or "+s);var v=function(a){a.success?(h[k.Id]=n,q.resolve(m)):(console.warn("SFDC/case: could not open tab"),q.reject())},w="/"+m;c.OPEN_EXISTING_CASE_IN_EDIT_MODE&&(w+="/e"),null!==r?(console.log("SFDC/case: primaryTabId="+r),b.openSubtab(r,w,!c.CONTACT_HAS_FOCUS,d.t("case.existing"),null,function(a){v(a)})):null===s||null===t||t!==k.Id&&t!==k.AccountId?(console.log("SFDC/case: open new primary tab"),b.openPrimaryTab(null,w,!c.CONTACT_HAS_FOCUS,d.t("case.existing"),function(a){v(a)})):(console.log("SFDC/case: currentPrimaryTabId="+s),b.openSubtab(s,w,!c.CONTACT_HAS_FOCUS,d.t("case.existing"),null,function(a){v(a)}))}else console.log("SFDC/case: no case"),q.reject()}return console.log("SFDC/case: pop - finished"),q.promise()},k=function(a){console.log("SFDC/case: getCaseNumber contact - "+a);var b=h[a];return void 0===b&&(b=null),b};return{initialize:function(a){null!==a&&""!==a&&(g=a)},search:i,pop:j,getCaseNumber:k}});