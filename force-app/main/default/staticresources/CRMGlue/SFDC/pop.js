define(["util","i18next","SFDC/api","config","SFDC/tracking","SFDC/case","SFDC/task","agent/comms","agent/interaction","moment"],function(a,b,c,d,e,f,g,h,i,j){function k(a,b){console.log(j().format("YYYY-MM-DD HH:mm:ss.SSS")+" "+m+"tabSuccess - start");var c=a.ixn,h=a.contact,k=$.Deferred();if(null===b||b.success||(console.warn("could not open pop tab"),b=null),null!==b&&(b.id=b.id||null,console.log(j().format("YYYY-MM-DD HH:mm:ss.SSS")+" "+m+"tab id is "+b.id)),e.add(c.id,null!==b?b.id:null,h),null!==c.id){var l={Action:"AttachData",ActionData:{id:c.id,userData:{sfdcObjectId:c.id}}};i.attachData(l),f.pop(a).then(function(b){e.setWhatId(c.id,b),a.caseId=b,setTimeout(function(){g.start(a).done(function(){k.resolve()})},d.UPDATE_DELAY)},function(){var b=e.getTaskId(c.id);b?ConnectorController.updateTaskDetails(b,h.Id,h.AccountId||null,function(a){k.resolve()}):setTimeout(function(){g.start(a).done(function(){k.resolve()})},d.UPDATE_DELAY)})}else k.reject();return console.log(j().format("YYYY-MM-DD HH:mm:ss.SSS")+" "+m+"tabSuccess - finish"),k.promise()}function l(a){console.log(j().format("YYYY-MM-DD HH:mm:ss.SSS")+" "+m+"addCaseAndTasks");var b=(a.ixn,a.contact),e=$.Deferred();return c.refreshPrimaryTabByName(b.Id,!0,function(f){if(f.success)console.log(m+"refresh successful"),c.getFocusedPrimaryTabId(function(b){f.id=b.id,k(a,f).then(function(){e.resolve()},function(){e.reject()})});else{var g=null;d.customPopURL&&(g=d.customPopURL(a)),g||(g="/"+b.Id),console.log(j().format("YYYY-MM-DD HH:mm:ss.SSS")+" "+m+"couldn't refresh so open primary tab on "+g),c.openPrimaryTab(null,g,!0,b.Name,function(b){k(a,b).then(function(){e.resolve()},function(){e.reject()})},b.Id)}}),e.promise()}var m="SFDC/pop: ",n=function(f){console.log(j().format("YYYY-MM-DD HH:mm:ss.SSS")+" "+m+"start");var h=f.ixn,i=f.contact,o=$.Deferred();if(!e.getTaskId(h.id)&&d.CONTACT_HAS_FOCUS&&c.isLightning())console.log(j().format("YYYY-MM-DD HH:mm:ss.SSS")+" "+m+"start task first"),g.start(f).then(function(){setTimeout(function(){return n(f)},d.UPDATE_DELAY)});else{c.fireOnCallBegin(h,b.t("mediaType."+h.mediaType)+" "+j().format("YYYY-MM-DD HH:mm:ss")),c.setCallAttachedData(h);var p=function(a){console.log(j().format("YYYY-MM-DD HH:mm:ss.SSS")+" "+m+"start: attachedDataChanged "+JSON.stringify(a.changedUserData)),h.userData=a.userData};a.getInstance("ixn.attachedDataChanged").subscribe(p),d.overridePop?d.overridePop(f):d.SHOW_CONTACT&&i?l(f).then(function(){a.getInstance("ixn.attachedDataChanged").unsubscribe(p),o.resolve()},function(){a.getInstance("ixn.attachedDataChanged").unsubscribe(p),o.reject()}):k(f,null).then(function(){a.getInstance("ixn.attachedDataChanged").unsubscribe(p),o.resolve()},function(){a.getInstance("ixn.attachedDataChanged").unsubscribe(p),o.reject()})}return console.log(j().format("YYYY-MM-DD HH:mm:ss.SSS")+" "+m+"start - finished"),o.promise()};return{start:n}});