define(["util","moment","SFDC/api","i18next","config","SFDC/tracking","agent/interaction"],function(a,b,c,d,e,f,g){var h="SFDC/task: ";return{start:function(i){if(console.log(b().format("YYYY-MM-DD HH:mm:ss.SSS")+" "+h+"start"),e.taskStartOverride)return e.taskStartOverride(i);var j=i.ixn,k=i.contact,l=i.caseId||null,m=i.popOnly||!1,n=$.Deferred();if(e.CREATE_TASK&&e.NEW_TASK_ON_POP&&!m){var o=l||(k?k.AccountId:null)||null,p=d.t("mediaType."+j.mediaType)+" "+b().format("YYYY-MM-DD HH:mm:ss"),q=f.getPrimaryTabId(j.id),r=f.getCurrentPrimaryTabObjectId();console.log(b().format("YYYY-MM-DD HH:mm:ss.SSS")+" "+h+"create task "+p);var s={};$.each(e.TASK_MAP_FIXED,function(a,b){console.log("SFDC/task: Fixed - "+a+"="+b),s[a]=b}),j.userData.mediaType=j.mediaType,j.userData.mediaTypeText=d.t("mediaType."+j.mediaType),$.each(e.TASK_MAP,function(a,b){var c=j.userData[b];void 0!==c&&(console.log("SFDC/task: Map - "+a+"("+b+")="+c),s[a]=c)}),ConnectorController.createTask(j.id,k?k.Id:null,o,p,j.userData,s,function(m){var p=f.getCurrentPrimaryTabId();if(null!==m){console.log(b().format("YYYY-MM-DD HH:mm:ss.SSS")+" "+h+"redirect to new task - "+m.Id+" under "+q+" or "+p);var s=function(a,b){a.success?f.setTaskTabId(j.id,a.id):console.warn("SFDC/task: could not open tab"),b?c.refreshPrimaryTabById(b,!1,function(){n.resolve()}):n.resolve()},t="/"+m.Id;e.OPEN_INITIAL_TASK_IN_EDIT_MODE&&(t+="/e"),f.setWhatId(j.id,o),f.setCaseId(j.id,l),f.setTaskId(j.id,m.Id);var u={Action:"AttachData",ActionData:{id:j.id,userData:{sfdcTaskId:m.Id}}};g.attachData(u),e.HIDE_TASK?c.refreshPrimaryTabById(q||p,!1,function(){n.resolve()}):null!==q?(console.log(b().format("YYYY-MM-DD HH:mm:ss.SSS")+" "+h+"primaryTabId="+q),c.openSubtab(q,t,!e.CONTACT_HAS_FOCUS,d.t("task.started"),null,function(a){a.success?s(a,q):c.openSubtab(p,t,!e.CONTACT_HAS_FOCUS,d.t("task.started"),null,function(a){s(a,p)})})):null!==p&&null!==r&&(k&&r===k.Id||k&&r===k.AccountId||r===l)?(console.log(b().format("YYYY-MM-DD HH:mm:ss.SSS")+" "+h+"currentPrimaryTabId="+p),c.openSubtab(p,t,!e.CONTACT_HAS_FOCUS,d.t("task.started"),null,function(a){s(a,p)})):(console.log(b().format("YYYY-MM-DD HH:mm:ss.SSS")+" "+h+"open new primary tab"),c.openPrimaryTab(null,t,!e.CONTACT_HAS_FOCUS,d.t("task.started"),function(a){s(a,null)})),a.getInstance("task.created").publish(i)}else console.warn("SFDC/task: Could not create task"),n.reject()})}else console.log(b().format("YYYY-MM-DD HH:mm:ss.SSS")+" "+h+"No task on pop"),n.reject();return console.log(b().format("YYYY-MM-DD HH:mm:ss.SSS")+" "+h+"start - finished"),n.promise()},finish:function(g,i,j,k){if(console.log(b().format("YYYY-MM-DD HH:mm:ss.SSS")+" "+h+"finish"),e.taskFinishOverride)return e.taskFinishOverride(g,coments,j,k);var l=$.Deferred();if(e.CREATE_TASK&&void 0===j.isConsult){var m=f.getPrimaryTabId(g),n=f.getTaskTabId(g),o=d.t("mediaType."+j.mediaType)+" "+b().format("YYYY-MM-DD HH:mm:ss");void 0===k&&(k=0),console.log(b().format("YYYY-MM-DD HH:mm:ss.SSS")+" "+h+"create/update the task");var p=f.getWhatId(g),q=f.getCurrentPrimaryTabObjectId(),r=f.getTaskId(g)||null;!r&&j.userData&&j.userData.sfdcTaskId&&(r=j.userData.sfdcTaskId,console.log(b().format("YYYY-MM-DD HH:mm:ss.SSS")+" "+h+"use sfdcTaskId ("+r+") on interaction"));var s=f.getContact(g),t=function(a,b){a.success||console.warn("SFDC/task: could not open tab"),b?c.refreshPrimaryTabById(b,!1,function(){l.resolve()}):l.resolve()};j.userData.mediaType=j.mediaType;var u={};void 0!==j.userData&&$.each(e.TASK_MAP,function(a,b){var c=b.split(":"),d=c[0];if(c.length>1){var e=j.userData[c[1]];void 0!==e&&(console.log("SFDC/task: Map - "+d+":"+e),u[d]=e)}}),ConnectorController.closeTask(j.id,s?s.Id:null,r,p,o,i,j.userData,e.DISPOSITION_KVP,u,k,function(i){var k=f.getCurrentPrimaryTabId();if(null!==i){console.log(b().format("YYYY-MM-DD HH:mm:ss.SSS")+" "+h+"redirect to new/existing task - "+i.Id+" under "+m+" or "+k);var o=f.getCaseId(g),p="/"+i.Id;e.OPEN_FINAL_TASK_IN_EDIT_MODE&&(p+="/e"),e.HIDE_TASK?c.refreshPrimaryTabById(m||k,!1,function(){l.resolve()}):m?(console.log(b().format("YYYY-MM-DD HH:mm:ss.SSS")+" "+h+"primaryTabId="+m),n&&c.closeTab(n),c.openSubtab(m,"/"+i.Id,!0,d.t("task.completed"),null,function(a){a.success?t(a,m):(console.log(b().format("YYYY-MM-DD HH:mm:ss.SSS")+" "+h+"currentPrimaryTabId="+k),c.openSubtab(k,"/"+i.Id,!0,d.t("task.completed"),null,function(a,b){t(a,b)}))})):null!==k&&null!==q&&(s&&q===s.Id||s&&q===s.AccountId||q===o)?(console.log(b().format("YYYY-MM-DD HH:mm:ss.SSS")+" "+h+"currentPrimaryTabId="+k),n&&c.closeTab(n),c.openSubtab(k,"/"+i.Id,!0,d.t("task.completed"),null,function(a){t(a,k)})):(console.log(b().format("YYYY-MM-DD HH:mm:ss.SSS")+" "+h+"open new primary tab - "+n),n&&c.closeTab(n),c.openPrimaryTab(null,"/"+i.Id,!0,d.t("task.completed"),function(a){s&&s.Id&&c.refreshPrimaryTabByName(s.Id,!0),t(a,null)}));var u={ixn:j,taskId:r};a.getInstance("task.completed").publish(u)}else console.warn(b().format("YYYY-MM-DD HH:mm:ss.SSS")+" "+h+"could not go to task"),l.reject()})}else console.log(b().format("YYYY-MM-DD HH:mm:ss.SSS")+" "+h+"No task on close"),l.reject();return console.log(b().format("YYYY-MM-DD HH:mm:ss.SSS")+" "+h+"finish - finished"),l.promise()}}});