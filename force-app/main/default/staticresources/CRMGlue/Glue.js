define(["jquery","util","config","SFDC/api","agent/session","agent/comms","SFDC/tracking","moment"],function(a,b,c,d,e,f,g,h){function i(e){"Complete"!==e.action&&console.log(h().format("YYYY-MM-DD HH:mm:ss.SSS")+" "+m+"processMessage - "+e.action);var f={};switch(e.action){case"OpenObject":switch(e.type){case"Voice":f={channel:"/v2/me/calls",data:{notificationType:"StatusChange",call:{id:e.id,state:"Established",ani:e.source,dnis:e.destination,callType:e.calltype,userData:e.userData},messageType:"CallStateChangeMessage",fieldName:e.fieldName,fieldValue:e.fieldValue}};break;case"Email":f={channel:"/v2/me/emails",data:{notificationType:"StatusChange",email:{id:e.id,state:"Processing",to:e.destination,from:e.source,userData:e.userData},messageType:"EmailStateChangeMessage",fieldName:e.fieldName,fieldValue:e.fieldValue}};break;case"Chat":f={channel:"/v2/me/chats",data:{notificationType:"StatusChange",chat:{id:e.id,state:"Chatting",userData:e.userData},messageType:"ChatStateChangeMessage",fieldName:e.fieldName,fieldValue:e.fieldValue}};break;case"Preview":f={channel:"/v2/me/outbound",data:{notificationType:"StatusChanged",record:{id:e.id,state:"ReadyToCall",phone:e.destination,customFields:e.customFields},messageType:"OutboundRecordMessage",fieldName:e.fieldName,fieldValue:e.fieldValue}};break;case"OpenMedia":f={channel:"/v2/me/openmedia",data:{notificationType:"StatusChange",openmedia:{id:e.id,state:"Chatting",mediaType:e.mediaType,userData:e.userData},messageType:"OpenMediaStateChangeMessage",fieldName:e.fieldName,fieldValue:e.fieldValue}}}b.getInstance("genesys.message").publish(f);break;case"CreateActivity":switch(e.type){case"Voice":f={channel:"/v2/me/calls",data:{notificationType:"StatusChange",call:{id:e.id,state:"Completed",ani:e.source,dnis:e.destination,callType:e.calltype,duration:e.duration,notes:e.notes,userData:e.userData},messageType:"CallStateChangeMessage"}};break;case"Email":f={channel:"/v2/me/emails",data:{notificationType:"StatusChange",email:{id:e.parentId||e.id,state:"Completed",duration:e.duration,notes:e.notes,emailDescription:e.emailDescription,userData:e.userData},messageType:"EmailStateChangeMessage"}};break;case"Chat":f={channel:"/v2/me/chats",data:{notificationType:"StatusChange",chat:{id:e.id,state:"Completed",duration:e.duration,notes:e.notes,transcript:e.transcript,userData:e.userData},messageType:"ChatStateChangeMessage"}};break;case"OpenMedia":f={channel:"/v2/me/openmedia",data:{notificationType:"StatusChange",openmedia:{id:e.id,mediaType:e.mediaType,state:"Completed",duration:e.duration,notes:e.notes,transcript:e.transcript,userData:e.userData},messageType:"OpenMediaStateChangeMessage"}}}b.getInstance("genesys.message").publish(f);break;case"IxnSelectedFromWDE":var i=e.actionData.id,j=g.getPrimaryTabId(i);j&&d.focusPrimaryTabById(j);break;case"ConnectionDenied":b.getInstance("glue.state").publish("not connected");break;case"AttachedDataChanged":var k=e;if(f={id:k.id,taskId:g.getTaskId(k.id)||k.userData.sfdcTaskId,userData:k.userData,changedUserData:k.changedUserData},f.taskId){var l={},n=!1;a.each(c.TASK_MAP,function(a,b){var c=k.changedUserData[b];void 0!==c&&(console.log(m+"Map - "+a+"("+b+")="+c),l[a]=c,n=!0)}),n&&ConnectorController.updateTask(f.taskId,k.userData,l,function(a){})}b.getInstance("ixn.attachedDataChanged").publish(f);break;case"ContactSelected":console.log(m+"ContactSelected - "+e.objectId+", "+e.id);var f={action:"ContactSelected",objectId:e.objectId,id:e.id};d.sendEvent(f)}}function j(){var d={CI:c.CI};a.ajax({url:c.URL+"/poll="+JSON.stringify(d),type:"GET",timeout:1e4,cache:!1,dataType:"jsonp",success:function(a){"NoWork"!==a.action&&i(a),connectionTimeout=setTimeout(function(){j()},100)},error:function(a,d,e){console.error(m+c.URL+" "+a.status+" "+e),b.getInstance("glue.state").publish("not connected"),connectionTimeout=setTimeout(function(){k()},5e3)}})}function k(){if(c.IS_UNIT_TEST)b.getInstance("glue.state").publish("connected");else if(console.log(m+"requestConnection: "+o),f.initialize(),c.USE_WEB_SOCKETS)b.getInstance("websocket.onopen").subscribe(function(){console.log(m+"onopen");var a={action:"ConnectionRequest"};f.send(a)}),b.getInstance("websocket.onmessage").subscribe(function(a){console.log(m+"onmessage");var c=JSON.parse(a.message);"ConnectionAccepted"===c.action?(console.log(m+"accepted"),b.getInstance("glue.state").publish("connected"),d.onFocusedPrimaryTab(function(a){g.primaryTabFocused(a);var b={action:"SetSessionFocusFromSFDC",actionData:{tabId:a.id}};f.send(b)})):i(c);var e={sessionid:a.sessionid,code:0,reason:"OK"};f.send(e)}),b.getInstance("websocket.onclose").subscribe(function(){console.warn(m+"onClose: disconnected"),b.getInstance("glue.state").publish("not connected"),setTimeout(function(){k()},1e4)});else{c.CI=o;var a={action:"ConnectionRequest"};f.send(a,function(a){"ConnectionAccepted"===a.action?(console.log(m+"accepted"),b.getInstance("glue.state").publish("connected"),j(),d.onFocusedPrimaryTab(function(a){g.primaryTabFocused(a);var b={action:"SetSessionFocusFromSFDC",actionData:{tabId:a.id}};f.send(b)})):"ConnectionDenied"===a.action?(console.warn(m+"connection denied, do not retry"),b.getInstance("glue.state").publish("not connected"),n=setTimeout(function(){k()},5e3)):n=setTimeout(function(){k()},5e3)},function(){n=setTimeout(function(){k()},5e3)})}}function l(d){try{console.log(m+"initialize"),b.getInstance("glue.state").publish("connecting"),c.PERSIST_USER_SETTINGS=d.persistUserSettings,c.SHOW_CONTACT=d.showContact,c.NO_DEFAULT_SEARCH=d.noDefaultSearch,c.NO_ANI_SEARCH=d.noANISearch,c.CONTACT_HAS_FOCUS=d.contactHasFocus,c.NEW_TASK_NO_CONTACT_FOUND=d.newTaskNoContactFound,c.NEW_OUTBOUND_TASK_NO_CONTACT_FOUND=d.newOutboundTaskNoContactFound,c.SHOW_CASE=d.showCase,c.NEW_CASE_ON_POP=d.newCaseOnPop,c.NEW_CASE_IF_NO_SEARCH_KVP_PRESENT=d.newCaseIfNoSearchKVPPresent,c.SEARCH_CASE_IF_WRONG_CASE=d.searchCaseIfWrongCase,c.OPEN_NEW_CASE_IN_EDIT_MODE=d.openNewCaseInEditMode,c.OPEN_EXISTING_CASE_IN_EDIT_MODE=d.openExistingCaseInEditMode,c.CREATE_TASK=d.createTask,c.NEW_TASK_ON_POP=d.newTaskOnPop,c.OPEN_INITIAL_TASK_IN_EDIT_MODE=d.openInitialTaskInEditMode,c.OPEN_FINAL_TASK_IN_EDIT_MODE=d.openFinalTaskInEditMode,c.HIDE_TASK=d.hideTask,c.SEARCH_URL=d.searchURL,c.UPDATE_DELAY=1e3;var f=d.taskMap.split(","),g={};a.each(f,function(a,b){var c=b.split(":"),d=c[0];if(c.length>1){var e=c[1];g[d]=e,console.log(m+"task map: "+d+"->"+e)}}),c.TASK_MAP=g,c.TASK_MAP_FIXED={};var h=d.caseMap.split(","),i={};a.each(h,function(a,b){var c=b.split(":"),d=c[0];if(c.length>1){var e=c[1];i[d]=e,console.log(m+"case map: "+d+"->"+e)}}),c.CASE_MAP=i,c.DISPOSITION_KVP=d.dispositionKVP,c.USE_WEB_SOCKETS=d.useWebSockets;var j=d.useLocalhost?"localhost":"127.0.0.1";c.USE_WEB_SOCKETS?c.URL="wss://"+j+":"+d.pollPort+"/SFDCSocketListener":c.URL="https://"+j+":"+d.pollPort,e.initialize(),k(),document.addEventListener("visibilitychange",function(){"visible"===document.visibilityState&&p()})}catch(a){console.error(m+"ERROR - "+a.stack)}}var m="Glue: ",n=null,o=(new Date).getTime()+"a",p=function(a){console.log(h().format("YYYY-MM-DD HH:mm:ss.SSS")+" "+m+"has focus");var b={action:"SetSessionFocusFromSFDC"};if(a&&a.result){var c=JSON.parse(a.result);c.objectId&&(b.actionData={tabId:c.objectId})}f.send(b)};return{initialize:l,terminate:function(){console.log(m+"terminate")}}});