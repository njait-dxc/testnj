define(["jquery","util","config"],function(a,b,c){var d;return{initialize:function(){c.USE_WEB_SOCKETS&&(b.getInstance("websocket.onopen").empty(),b.getInstance("websocket.onmessage").empty(),b.getInstance("websocket.onclose").empty(),d=new WebSocket(c.URL),d.onopen=function(a){console.log("onOpen"),b.getInstance("websocket.onopen").publish()},d.onmessage=function(a){console.log("onmessage: "+a.data);var c=JSON.parse(a.data);b.getInstance("websocket.onmessage").publish(c)},d.onerror=function(a){console.error("onError")},d.onclose=function(a){console.warn("onClose: disconnected"),b.getInstance("websocket.onclose").publish()})},send:function(b,e,f){c.CI&&(b.CI=c.CI);var g=JSON.stringify(b);if(!c.IS_UNIT_TEST){console.log("agent/comms: send - "+g);try{c.USE_WEB_SOCKETS?d.send(g):a.ajax({url:c.URL,data:"/request="+g,type:"GET",timeout:5e3,processData:!1,cache:!1,dataType:"jsonp",success:function(a){e&&e(a)},error:function(a,b,d){console.error("agent/comms: "+c.URL+" "+b+" - "+a.status+" "+d),f&&f(a,b,d)}})}catch(a){console.error("agent/comms: ERROR - "+a.stack)}}}}});